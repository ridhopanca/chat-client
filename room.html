<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Room page realtime chat</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
		integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/fontawesome.min.css"
		integrity="sha512-xX2rYBFJSj86W54Fyv1de80DWBq7zYLn2z0I9bIhQG+rxIF6XVJUpdGnsNHWRa6AvP89vtFupEPDP8eZAtu9qA=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />

	<style>
		.chat-messages {
			/* display: flex;
			flex-direction: column;
			word-wrap: break-word; */
			max-height: 80vh;
			overflow-y: scroll;
			-ms-overflow-style: none;
			/* IE and Edge */
			scrollbar-width: none;
			/* Firefox */
		}

		.chat-messages::-webkit-scrollbar {
			display: none;
		}

		/* .chat-message-left,
		.chat-message-right {
			display: flex;
			flex-shrink: 0;
		} */

		.word-break {
			word-break: break-word;
		}

		.fs-10 {
			font-size: 10px;
		}

		/* .chat-message-left {
			margin-right: auto;
		}

		.chat-message-right {
			flex-direction: row-reverse;
			margin-left: auto
		} */
		.lds-ring div {
			box-sizing: border-box;
			display: block;
			position: absolute;
			width: 18px;
			height: 18px;
			left: 50%;
			margin: 2px;
			border: 2px solid #55585C;
			border-radius: 50%;
			animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
			border-color: #55585C transparent transparent transparent;
		}
		.lds-ring div:nth-child(1) {
			animation-delay: -0.45s;
		}
		.lds-ring div:nth-child(2) {
			animation-delay: -0.3s;
		}
		.lds-ring div:nth-child(3) {
			animation-delay: -0.15s;
			}
			@keyframes lds-ring {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}
	</style>
</head>


<body>
	<section>
		<div class="d-flex justify-content-center">
			<div class="col-lg-3 col-11">
				<div class="card border-dark border-2 mt-2">
					<div class="card-header border-dark bg-dark text-white border-2 d-flex align-items-center">
						<button class="btn btn-dark" onclick="back();"><i class="fa-solid fa-arrow-left"></i></button>
						<div class="ms-2">
							<p class="m-0">Room: <span class="fw-semibold m-0" id="nameRoom"></span></p>
						</div>
					</div>
					<div class="card-body bg-secondary text-dark bg-opacity-10">
						<div class="lds-ring d-none"><div></div><div></div><div></div><div></div></div>
						<div id="conversation" class="chat-messages">
						</div>
					</div>
					<div class="d-flex card-footer">
						<div class="flex-fill">
							<input type="text" class="form-control rounded-pill" name="message" placeholder="Type Message..." />
						</div>
						<button id="sendMessage" class="btn btn-light ms-2"><i class="fa-solid fa-paper-plane"></i></button>
					</div>
				</div>
			</div>
		</div>

		<main class="content d-none">
			<div class="container p-0">
				<div class="card">
					<div class="row">
						<div class="col-12 col-lg-7 col-xl-9">
							<div class="position-relative">
								<div class="chat-messages p-4">

									<div class="mb-3 chat-message-right">
										<div>
											<img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1"
												alt="Chris Wood" width="40" height="40">
											<div class="text-muted small text-nowrap mt-2">2:33 am</div>
										</div>
										<div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
											<div class="font-weight-bold mb-1">You</div>
											Lorem ipsum dolor sit amet, vis erat denique in, dicunt prodesset te vix.
										</div>
									</div>

									<div class="mb-3 chat-message-left">
										<div>
											<img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1"
												alt="Sharon Lessman" width="40" height="40">
											<div class="text-muted small text-nowrap mt-2">2:34 am</div>
										</div>
										<div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
											<div class="font-weight-bold mb-1">Sharon Lessman</div>
											Sit meis deleniti eu, pri vidit meliore docendi ut, an eum erat animal commodo.
										</div>
									</div>

									<div class="mb-3 chat-message-right">
										<div>
											<img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1"
												alt="Chris Wood" width="40" height="40">
											<div class="text-muted small text-nowrap mt-2">2:35 am</div>
										</div>
										<div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
											<div class="font-weight-bold mb-1">You</div>
											Cum ea graeci tractatos.
										</div>
									</div>

									<div class="mb-3 chat-message-left">
										<div>
											<img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1"
												alt="Sharon Lessman" width="40" height="40">
											<div class="text-muted small text-nowrap mt-2">2:36 am</div>
										</div>
										<div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
											<div class="font-weight-bold mb-1">Sharon Lessman</div>
											Sed pulvinar, massa vitae interdum pulvinar, risus lectus porttitor magna, vitae commodo lectus
											mauris et velit.
											Proin ultricies placerat imperdiet. Morbi varius quam ac venenatis tempus.
										</div>
									</div>
								</div>
							</div>

							<div class="flex-grow-0 py-3 px-4 border-top">
								<div class="input-group">
									<input type="text" class="form-control" placeholder="Type your message">
									<button class="btn btn-primary">Send</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</section>
	<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script>
		let urlHost = 'http://10.10.20.223:3000/'; //change with your local server
		let roomId = localStorage.getItem('chatRoomId');
		let roomName = localStorage.getItem('chatRoomName');
		let userId = localStorage.getItem('chatUserId');
		let username = localStorage.getItem('chatUserName');
		let auth = localStorage.getItem('chatAuth');
		let page = 0;
		const socket = io(urlHost);
		getData();
		socket.on('connect', function () {
			console.log("Connected to WS server");
			console.log(socket.connected)
			socket.on('new message', (response) => {
				let data = response.message;
				let template = "";
				let fullname = data.postedByUser.firstName + ' ' + data.postedByUser.lastName;
				let substring = data.postedByUser.firstName.substr(0, 1);
				if (fullname == username) {
					template += `
						<div class="flex-row-reverse mb-2 ms-auto d-flex text-end">
							<div class="ms-2">
								<img src="https://via.placeholder.com/35x35/55585C/ffffff.jpg?text=${substring}" class="rounded-circle mr-1"
									alt="Chris Wood">
							</div>
							<div>
								<small class="fw-semibold mb-1 fs-10">${data.postedByUser.firstName}</small>
								<div class="flex-shrink-1 bg-dark bg-opacity-75 text-white rounded p-2">
									<p class="word-break m-0">${data.message.messageText}</p>
								</div>
								<small class="fs-10 text-secondary text-opacity-50">${convertDate(data.createdAt)}</small>
							</div>
						</div>
						`;
				} else {
					template += `
						<div class="mb-2 me-auto d-flex text-first">
							<div class="me-2">
								<img src="https://via.placeholder.com/35x35/ffffff/55585C.jpg?text=${substring}" class="rounded-circle mr-1"
									alt="Sharon Lessman">
							</div>
							<div>
								<div class="fw-semibold mb-1 fs-10 ">${data.postedByUser.firstName}</div>
								<div class="flex-shrink-1 bg-light rounded p-2">
									<p class="word-break m-0">${data.message.messageText}</p>
								</div>
								<small class="fs-10 text-secondary text-opacity-50">${convertDate(data.createdAt)}</small>
							</div>
						</div>
						`;
				}
				$('#conversation').append(template);
				var objDiv = document.getElementById("conversation");
				objDiv.scrollTop = objDiv.scrollHeight;
			})
		});
		socket.emit('identity', userId);
		socket.emit('subscribe', roomId);
		$('#nameRoom').text(roomName);

		function getData() {
			$.ajax({
				url: urlHost + 'api/room/' + roomId,
				method: 'GET',
				headers: {
					'authorization': `Bearer ${auth}`
				},
				dataType: 'json',
				success: function (response) {
					let template = '';
					const chat = response.conversation;
					if (chat.length > 0) {
						$.each(chat, function (key, val) {
							let fullname = val.postedByUser.firstName + ' ' + val.postedByUser.lastName;
							let substring = val.postedByUser.firstName.substr(0, 1);
							if (fullname == username) {

								template += `
									<div class="flex-row-reverse mb-2 ms-auto d-flex text-end">
										<div class="ms-2">
											<img src="https://via.placeholder.com/35x35/55585C/ffffff.jpg?text=${substring}" class="rounded-circle mr-1"
												alt="Chris Wood">
										</div>
										<div>
											<small class="fw-semibold mb-1 fs-10">${val.postedByUser.firstName}</small>
											<div class="flex-shrink-1 bg-dark bg-opacity-75 text-white rounded p-2">
												<p class="word-break m-0">${val.message.messageText}</p>
											</div>
											<small class="text-secondary text-opacity-50 fs-10">${convertDate(val.createdAt)}</small>
										</div>
									</div>
									`;
							} else {
								template += `
									<div class="mb-2 me-auto d-flex text-first">
										<div class="me-2">
											<img src="https://via.placeholder.com/35x35/ffffff/55585C.jpg?text=${substring}" class="rounded-circle mr-1"
												alt="Sharon Lessman">
										</div>
										<div>
											<div class="fw-semibold mb-1 fs-10 ">${val.postedByUser.firstName}</div>
											<div class="flex-shrink-1 bg-light rounded p-2">
												<p class="word-break m-0">${val.message.messageText}</p>
											</div>
											<small class="text-secondary text-opacity-50 fs-10">${convertDate(val.createdAt)}</small>
										</div>
									</div>
									`;
							}
						});
					}
					$('#conversation').html(template);
					var objDiv = document.getElementById("conversation");
					objDiv.scrollTop = objDiv.scrollHeight;
				},
				error: function (xhr) {
					alert(xhr.responseJSON.message);
					console.log(xhr);
				}
			});
		}

		function convertDate(date) {
			var data = new Date(date);
			var year = data.getFullYear();
			var month = data.getMonth() + 1;
			var dt = data.getDate();
			var hour = data.getHours();
			var min = data.getMinutes();
			if (month < 10) {
				month = '0' + month;
			}
			if (dt < 10) {
				dt = '0' + dt;
			}
			if (hour < 10) {
				hour = '0' + hour;
			}
			if (min < 10) {
				min = '0' + min;
			}
			var result = year + '/' + month + '/' + dt + ' ' + hour + ':' + min;
			return result;
		}

		function back() {
			socket.emit('unsubscribe', roomId);
			socket.disconnect();
			document.location = './home.html';
		}
		$("input[name=message]").keypress(function (e) {
			if (e.keyCode == 13) {
				sendMessage();
			}
		});
		$('#sendMessage').click(function () {
			sendMessage();
		})

		function sendMessage() {
			var message = $('input[name=message]').val();
			$.ajax({
				url: urlHost + 'api/room/' + roomId + '/message',
				headers: {
					'Content-Type': 'application/json',
					'authorization': `Bearer ${auth}`
				},
				method: 'POST',
				dataType: 'json',
				data: JSON.stringify({
					messageText: message
				}),
				success: function (response) {
					$('input[name=message]').val('');
				},
				error: function (xhr) {
					alert(xhr.responseJSON.message)
				}
			});
		}
		const yd=$('#conversation');
        var lastScrollTop=Infinity;
        yd.scrollTop(yd.prop("scrollHeight") - yd.prop("clientHeight")).on('wheel',wheel);
        function wheel(){
            const st=$(this).scrollTop();
            if (st<=lastScrollTop && st<300) {getMore()};
            lastScrollTop=st;
        }
        function getMore(){
			page = page + 1;
			$.ajax({
					url: urlHost + 'api/room/' + roomId + '?page=' + page,
					method: 'GET',
					headers: {
						'authorization': `Bearer ${auth}`
					},
					dataType: 'json',
					success: function (response) {
						let template = '';
						const chat = response.conversation;
						if (chat.length > 0) {
							$.each(chat, function (key, val) {
								let fullname = val.postedByUser.firstName + ' ' + val.postedByUser.lastName;
								let substring = val.postedByUser.firstName.substr(0, 1);
								if (fullname == username) {

									template += `
										<div class="flex-row-reverse mb-2 ms-auto d-flex text-end">
											<div class="ms-2">
												<img src="https://via.placeholder.com/35x35/55585C/ffffff.jpg?text=${substring}" class="rounded-circle mr-1"
													alt="Chris Wood">
											</div>
											<div>
												<small class="fw-semibold mb-1 fs-10">${val.postedByUser.firstName}</small>
												<div class="flex-shrink-1 bg-dark bg-opacity-75 text-white rounded p-2">
													<p class="word-break m-0">${val.message.messageText}</p>
												</div>
												<small class="text-secondary text-opacity-50 fs-10">${convertDate(val.createdAt)}</small>
											</div>
										</div>
										`;
								} else {
									template += `
										<div class="mb-2 me-auto d-flex text-first">
											<div class="me-2">
												<img src="https://via.placeholder.com/35x35/ffffff/55585C.jpg?text=${substring}" class="rounded-circle mr-1"
													alt="Sharon Lessman">
											</div>
											<div>
												<div class="fw-semibold mb-1 fs-10 ">${val.postedByUser.firstName}</div>
												<div class="flex-shrink-1 bg-light rounded p-2">
													<p class="word-break m-0">${val.message.messageText}</p>
												</div>
												<small class="text-secondary text-opacity-50 fs-10">${convertDate(val.createdAt)}</small>
											</div>
										</div>
										`;
								}
							});
							$('.lds-ring').toggleClass('d-none');
							const lastHeight=yd.prop("scrollHeight")
							yd.prepend(template)
							yd.scrollTop(yd.prop("scrollHeight")-lastHeight+4);
							yd.off("wheel",wheel);
							setTimeout(function(){
								yd.on('wheel',wheel);
								$('.lds-ring').toggleClass('d-none');
							},2000);
						} else {
							page = page - 1;
						}
					},
					error: function (xhr) {
						alert(xhr.responseJSON.message);
						console.log(xhr);
					}
				});
        }
	</script>
</body>

</html>